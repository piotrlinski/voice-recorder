name: ðŸ“š Documentation Build & Deploy

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'src/**'
      - 'pyproject.toml'
      - 'Makefile'
      - '.github/workflows/docs.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'src/**'
      - 'pyproject.toml'
      - 'Makefile'
      - '.github/workflows/docs.yml'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force complete rebuild'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: docs-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: Build Documentation
  build:
    name: ðŸ”¨ Build Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ðŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[docs]"
        
    - name: ðŸ” Validate Documentation Source
      run: |
        echo "ðŸ“‹ Documentation Source Validation"
        echo "=================================="
        
        # Check for required files
        required_files=(
          "docs/conf.py"
          "docs/index.rst" 
          "src/voice_recorder/__init__.py"
        )
        
        for file in "${required_files[@]}"; do
          if [[ -f "$file" ]]; then
            echo "âœ… $file exists"
          else
            echo "âŒ $file missing"
            exit 1
          fi
        done
        
        # Validate Sphinx configuration
        python -c "
        import sys
        sys.path.insert(0, 'docs')
        try:
            import conf
            print('âœ… Sphinx configuration valid')
        except Exception as e:
            print(f'âŒ Sphinx configuration error: {e}')
            sys.exit(1)
        "
        
        # Check for circular imports
        python -c "
        try:
            import voice_recorder
            print('âœ… Package imports successfully')
        except Exception as e:
            print(f'âŒ Package import error: {e}')
            sys.exit(1)
        "
    
    - name: ðŸ§¹ Clean Previous Builds
      run: |
        echo "ðŸ§¹ Cleaning previous builds..."
        make docs-clean || true
        rm -rf docs/_build docs/*.html docs/_static docs/_sources docs/_modules || true
        
    - name: ðŸ—ï¸ Build Documentation
      run: |
        echo "ðŸ—ï¸ Building Sphinx documentation..."
        
        # Build with verbose output for debugging
        sphinx-build -b html -v -W --keep-going docs docs/_build/html
        
        # Verify build output
        if [[ ! -f "docs/_build/html/index.html" ]]; then
          echo "âŒ Build failed: No index.html generated"
          exit 1
        fi
        
        echo "âœ… Documentation built successfully"
        
    - name: ðŸ“Š Build Quality Report
      run: |
        echo "ðŸ“Š Documentation Build Report"
        echo "============================="
        
        build_dir="docs/_build/html"
        
        # Count generated files
        html_count=$(find "$build_dir" -name "*.html" | wc -l)
        css_count=$(find "$build_dir" -name "*.css" | wc -l)
        js_count=$(find "$build_dir" -name "*.js" | wc -l)
        
        echo "ðŸ“„ HTML files: $html_count"
        echo "ðŸŽ¨ CSS files: $css_count" 
        echo "âš¡ JS files: $js_count"
        
        # Check critical files
        critical_files=(
          "$build_dir/index.html"
          "$build_dir/genindex.html"
          "$build_dir/search.html"
          "$build_dir/_static/theme.css"
        )
        
        echo ""
        echo "ðŸ” Critical Files Check:"
        for file in "${critical_files[@]}"; do
          if [[ -f "$file" ]]; then
            size=$(du -h "$file" | cut -f1)
            echo "âœ… $(basename "$file") ($size)"
          else
            echo "âŒ $(basename "$file") missing"
          fi
        done
        
        # Calculate total size
        total_size=$(du -sh "$build_dir" | cut -f1)
        echo ""
        echo "ðŸ“ Total documentation size: $total_size"
        
    - name: ðŸ”— Validate Links and References
      run: |
        echo "ðŸ”— Validating internal links..."
        
        # Check for broken internal references
        python -c "
        import os
        import re
        from pathlib import Path
        
        build_dir = Path('docs/_build/html')
        broken_links = []
        
        for html_file in build_dir.rglob('*.html'):
            content = html_file.read_text(encoding='utf-8', errors='ignore')
            
            # Find internal links
            internal_links = re.findall(r'href=\"([^\"]*\.html[^\"]*?)\"', content)
            
            for link in internal_links:
                if link.startswith('http'):
                    continue
                    
                # Remove anchor fragments
                link_path = link.split('#')[0]
                if not link_path:
                    continue
                    
                # Resolve relative path
                target = (html_file.parent / link_path).resolve()
                
                if not target.exists():
                    broken_links.append(f'{html_file.name} -> {link}')
        
        if broken_links:
            print('âŒ Broken internal links found:')
            for link in broken_links[:10]:  # Show first 10
                print(f'  - {link}')
            if len(broken_links) > 10:
                print(f'  ... and {len(broken_links) - 10} more')
        else:
            print('âœ… All internal links valid')
        "
        
    - name: ðŸ“¤ Prepare GitHub Pages Artifact
      run: |
        echo "ðŸ“¤ Preparing GitHub Pages deployment..."
        
        # Copy built documentation to docs/ for GitHub Pages
        cp -r docs/_build/html/* docs/
        
        # Ensure .nojekyll exists
        touch docs/.nojekyll
        
        # Create deployment summary
        cat > docs/deployment-info.json << EOF
        {
          "build_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "commit_sha": "${{ github.sha }}",
          "commit_ref": "${{ github.ref }}",
          "workflow_run": "${{ github.run_number }}",
          "python_version": "$(python --version)",
          "sphinx_version": "$(python -c 'import sphinx; print(sphinx.__version__)')"
        }
        EOF
        
        echo "âœ… GitHub Pages artifact prepared"
        
    - name: ðŸ“‹ Generate Deployment Summary
      run: |
        echo "## ðŸ“š Documentation Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ—ï¸ Build Status | âœ… Success |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“„ HTML Files | $(find docs/_build/html -name "*.html" | wc -l) |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“ Total Size | $(du -sh docs/_build/html | cut -f1) |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ• Build Time | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”„ Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“– [View Documentation](https://piotrlinski.github.io/voice-recorder/)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ  [Homepage](https://piotrlinski.github.io/voice-recorder/index.html)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ” [Search](https://piotrlinski.github.io/voice-recorder/search.html)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“š [API Reference](https://piotrlinski.github.io/voice-recorder/api/index.html)" >> $GITHUB_STEP_SUMMARY
        
    - name: ðŸ—‚ï¸ Upload Documentation Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: docs/

  # Job 2: Deploy to GitHub Pages
  deploy:
    name: ðŸš€ Deploy to GitHub Pages
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: build
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
    - name: ðŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: ðŸ” Post-Deployment Validation
      run: |
        echo "ðŸ” Validating deployment..."
        
        # Wait for deployment to be accessible
        sleep 30
        
        # Test main documentation URL
        url="${{ steps.deployment.outputs.page_url }}"
        
        echo "Testing: $url"
        
        # Check if site is accessible
        if curl -sSf -o /dev/null "$url"; then
          echo "âœ… Documentation site is accessible"
        else
          echo "âŒ Documentation site not accessible"
          echo "â³ Note: It may take a few minutes for changes to propagate"
        fi
        
    - name: ðŸ“Š Deployment Summary
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Status | Details |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŽ¯ Deployment | âœ… Successful |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŒ URL | [${{ steps.deployment.outputs.page_url }}](${{ steps.deployment.outputs.page_url }}) |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ• Deploy Time | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“‹ Environment | github-pages |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. ðŸ”— Visit the [documentation site](${{ steps.deployment.outputs.page_url }})" >> $GITHUB_STEP_SUMMARY
        echo "2. ðŸ§ª Test all pages and functionality" >> $GITHUB_STEP_SUMMARY
        echo "3. ðŸ“± Verify mobile responsiveness" >> $GITHUB_STEP_SUMMARY
        echo "4. ðŸ” Check search functionality" >> $GITHUB_STEP_SUMMARY

  # Job 3: Quality Assurance (runs on PRs)
  quality-check:
    name: ðŸ” Documentation QA
    if: github.event_name == 'pull_request'
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Download Build Artifact
      uses: actions/download-artifact@v4
      with:
        name: github-pages
        path: qa-docs/
        
    - name: ðŸ§ª Extract and Analyze
      run: |
        cd qa-docs
        tar -xf artifact.tar
        
        echo "## ðŸ” Documentation QA Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check for accessibility issues
        echo "### â™¿ Accessibility Check" >> $GITHUB_STEP_SUMMARY
        if grep -r "alt=" . >/dev/null; then
          echo "âœ… Alt text found in images" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ No alt text found - verify image accessibility" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Check for responsive design
        echo "### ðŸ“± Responsive Design" >> $GITHUB_STEP_SUMMARY
        if grep -r "viewport" . >/dev/null; then
          echo "âœ… Viewport meta tags found" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ No viewport meta tags - mobile experience may be poor" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Performance analysis
        echo "### âš¡ Performance Analysis" >> $GITHUB_STEP_SUMMARY
        total_size=$(du -sh . | cut -f1)
        echo "ðŸ“ Total size: $total_size" >> $GITHUB_STEP_SUMMARY
        
        large_files=$(find . -size +1M -type f | wc -l)
        if [[ $large_files -gt 0 ]]; then
          echo "âš ï¸ Found $large_files files larger than 1MB" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… No large files detected" >> $GITHUB_STEP_SUMMARY
        fi